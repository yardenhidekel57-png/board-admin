<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×œ×•×— ××•×“×¢×•×ª</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 15px; margin: 0; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #1e3a8a; margin: 0 0 15px 0; font-size: 20px; }
        textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; resize: none; }
        button { width: 100%; padding: 12px; background: #0ea5e9; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:active { opacity: 0.8; }
        .msg-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; gap: 10px; text-align: right; }
        .msg-text { flex: 1; font-size: 15px; color: #334155; line-height: 1.4; }
        .del-btn { background: #ef4444; width: auto; padding: 6px 12px; font-size: 13px; margin: 0; }
        #status { font-weight: bold; margin-bottom: 10px; min-height: 24px; color: #1e3a8a; font-size: 14px; }
        .debug-info { font-size: 10px; color: #bbb; margin-top: 30px; border-top: 1px dashed #ddd; padding-top: 10px; direction: ltr; overflow: hidden; }
    </style>
</head>
<body>

    <div id="status">××ª×—×‘×¨ ×œ××¢×¨×›×ª...</div>

    <div class="card">
        <h2>ğŸ“¢ ×”×•×“×¢×” ×—×“×©×”</h2>
        <textarea id="msgInput" rows="3" placeholder="××” ×ª×¨×¦×• ×œ×›×ª×•×‘ ×‘×œ×•×—?"></textarea>
        <button id="sendBtn" onclick="sendUpdate()">×©×œ×— ×œ×œ×•×—</button>
    </div>

    <div class="card">
        <h2>ğŸ“ ×”×•×“×¢×•×ª ×¤×¢×™×œ×•×ª</h2>
        <div id="messagesList">×˜×•×¢×Ÿ ×”×•×“×¢×•×ª...</div>
    </div>

    <div id="debug" class="debug-info"></div>

    <script>
        // ×•×•×“× ×©×–×” ×”×§×™×©×•×¨ ×”×¢×“×›× ×™ ×‘×™×•×ª×¨ ×©×œ×š ××”-Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRkk7x_2EbkzPbfwobm_6pkOa7MkPrO1wLbra16MhG3tcXctjy5hYANA0jo3IS4kM/exec';

        async function loadMessages() {
            const list = document.getElementById('messagesList');
            const statusDiv = document.getElementById('status');
            const debugDiv = document.getElementById('debug');
            
            try {
                const res = await fetch(SCRIPT_URL + '?t=' + Date.now());
                if (!res.ok) throw new Error('Network Error');
                
                const data = await res.json();
                debugDiv.innerText = "Data received: " + JSON.stringify(data).substring(0, 100);

                // × ×™×ª×•×— ×”××‘× ×”: ×‘×•×“×§ ×× ×”× ×ª×•× ×™× ×‘×ª×•×š "messages" ××• ×©×”× ××¢×¨×š ×™×©×™×¨
                const messagesArray = Array.isArray(data) ? data : (data.messages || []);

                if (messagesArray.length === 0) {
                    list.innerHTML = '××™×Ÿ ×”×•×“×¢×•×ª ×¤×¢×™×œ×•×ª ×‘×œ×•×—';
                } else {
                    list.innerHTML = '';
                    messagesArray.forEach((msg, index) => {
                        // ×—×™×œ×•×¥ ×”×˜×§×¡×˜ (×‘×™×Ÿ ×× ×–×” ××•×‘×™×™×§×˜ ××• ×¡×ª× ××—×¨×•×–×ª)
                        const text = typeof msg === 'object' ? msg.text : msg;
                        const id = (typeof msg === 'object' && msg.id) ? msg.id : index + 1;
                        
                        if(text) {
                            list.innerHTML += `
                                <div class="msg-item">
                                    <span class="msg-text">${text}</span>
                                    <button class="del-btn" onclick="deleteMessage(${id})">××—×§</button>
                                </div>
                            `;
                        }
                    });
                }
                statusDiv.innerText = "××—×•×‘×¨ ×•××¢×•×“×›×Ÿ âœ…";
                statusDiv.style.color = "green";
            } catch (e) {
                console.error(e);
                statusDiv.innerText = "×©×’×™××ª ×˜×¢×™× ×” âŒ";
                statusDiv.style.color = "red";
                debugDiv.innerText = "Error: " + e.message;
            }
        }

        async function sendUpdate() {
            const input = document.getElementById('msgInput');
            const btn = document.getElementById('sendBtn');
            const text = input.value.trim();
            
            if(!text) return;

            document.getElementById('status').innerText = "×©×•×œ×— ×”×•×“×¢×”...";
            btn.disabled = true;

            try {
                // ×©×œ×™×—×” ×‘-no-cors ×›×™ ×’×•×’×œ ×œ× ××—×–×™×¨ ××™×©×•×¨ POST ×ª×§×™×Ÿ ×œ-JS
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ type: 'message', text: text })
                });
                
                input.value = "";
                document.getElementById('status').innerText = "×”×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!";
                setTimeout(loadMessages, 2000);
            } catch (e) {
                alert("×—×œ×” ×©×’×™××” ×‘×©×œ×™×—×”");
            } finally {
                btn.disabled = false;
            }
        }

        async function deleteMessage(id) {
            if(!confirm("×œ××—×•×§ ××ª ×”×”×•×“×¢×”?")) return;
            
            document.getElementById('status').innerText = "××•×—×§ ×”×•×“×¢×”...";
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ type: 'delete_row', rowId: id })
                });
                
                document.getElementById('status').innerText = "×”×”×•×“×¢×” × ××—×§×”!";
                setTimeout(loadMessages, 2000);
            } catch (e) {
                alert("×—×œ×” ×©×’×™××” ×‘××—×™×§×”");
            }
        }

        // ×”×¤×¢×œ×” ××•×˜×•××˜×™×ª ×‘×˜×¢×™× ×”
        loadMessages();
    </script>
</body>
</html>
